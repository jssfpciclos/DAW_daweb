# CASO PRCTICO. Construci贸n de imagenes con DockerFile

## Objetivo

Aprender a crear im谩genes con Docker, a trav茅s de DockerFile

## Requisitos

- Tener instalado Docker en nuestro ordenador.
- Leer documentaci贸n DockerFile [aqu铆](../021.creacion-imagenes.md)

## 讹 Caso pr谩ctico 1. Construcci贸n de imagen con una Aplicaci贸n Python

En este ejemplo vamos a construir una imagen para servir una aplicaci贸n escrita en Python utilizando el framework `flask`. La aplicaci贸n ser谩 servida en el puerto `3000/tcp`. 

En el contexto vamos a tener el fichero Dockerfile y un directorio, llamado app con nuestra aplicaci贸n.
Descargar los recursos para este ejemplo desde [aqu铆](res/docker-file.caso-practico1.resources.rar)

En este caso vamos a usar una imagen base de un sistema operativo sin ning煤n servicio. El fichero Dockerfile ser谩 el siguiente:

```dockerfile	
FROM debian:buster-slim
# Instalamos python3 y pip3, y limpiamos la cache
RUN apt-get update && apt-get install -y python3-pip  && apt-get clean && rm -rf /var/lib/apt/lists/*
# Copiamos la carpeta app/ (la aplicaci贸n) al directorio /usr/share
COPY app /usr/share/app
# Establecemos el directorio de trabajo donde hemos copiado la aplicaci贸n
WORKDIR /usr/share/app
# Instalamos las dependencias de la aplicaci贸n
RUN pip3 install --no-cache-dir -r requirements.txt
# Exponemos el puerto 3000
EXPOSE 3000
# Ejecutamos la aplicaci贸n. Ya que el directorio de trabajo es /usr/share/app, no es necesario poner la ruta completa
CMD [ "python3", "app.py"]
```

**Algunas consideraciones:**

- S贸lo tenemos que instalar pip, que utilizaremos posteriormente para instalar los paquetes Python.
- Copiamos nuestra aplicaci贸n en cualquier directorio. (En este caso /usr/share/app)
- Con `WORKDIR` nos posicionamos en el directorio indicado. Todas las instrucciones posteriores se realizar谩n sobre ese directorio.
- Instalamos los paquetes python con pip, que est谩n listados en el fichero requirements.txt.
- El proceso que se va a ejecutar por defecto al iniciar el contenedor ser谩 python3 app.py que arranca un servidor web en el puerto 3000/tcp ofreciendo la aplicaci贸n.


**Construcci贸n de la imagen**

Para construir la imagen, nos situamos en el directorio donde tenemos el fichero Dockerfile y ejecutamos:

```bash
docker build -t iessdf/imagen-web-python:v1 .
```

Comprobar que la imagen se ha creado:

```bash
docker images

REPOSITORY                 TAG                 IMAGE ID            CREATED             SIZE
iessdf/imagen-web-python   v1                  5f6b6b6b6b6b        2 minutes ago       126MB
```

Y crear el contendores a partir de la imagen:

```bash
docker run -d --name web-python -p 80:3000 iessdf/imagen-web-python:v1
```

Y acceder con el navegador a la direcci贸n http://localhost


<img src="res/img/04.caso-practico1.png">




## 讹 Caso pr谩ctico 2. Construcci贸n de imagen con una Aplicaci贸n PHP (Version 1)

En este ejemplo vamos a crear una im谩gen con una p谩gina desarrollada con `PHP`. 

En el contexto vamos a tener el fichero Dockerfile y un directorio, llamado app con nuestra aplicaci贸n.
Descargar los recursos para este ejemplo desde [aqu铆](res/docker-file.caso-practico2.resources.rar), en el directorio `build` donde tenemos el fichero Dockerfile (rar contiene carpeta `app`).

En este caso vamos a usar una imagen base con el ejemplo anterior. El fichero Dockerfile ser谩 el siguiente:

```dockerfile
FROM debian:buster-slim
# Instalamos apache2 y php7.3, y limpiamos la cache
RUN apt-get update && apt-get install -y apache2 libapache2-mod-php7.3 php7.3 && apt-get clean && rm -rf /var/lib/apt/lists/*
# Copiamos la carpeta app/ (la aplicaci贸n) al directorio /var/www/html (directorio por defecto de apache2)
ADD app /var/www/html/
# Borramos el fichero index.html que viene por defecto en apache
RUN rm /var/www/html/index.html
# Exponemos el puerto 80 (por defecto de apache)
EXPOSE 80
# Ejecutamos apache2 en primer plano
CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
```

**Algunas consideraciones:**

- Al usar una imagen base debian tenemos que instalar los paquetes necesarios para tener el servidor web, php y las librerias necesarias.
- Como el ejemplo anterior, copiamos los archivos de la aplicaci贸n (dentro del directorio app) en el directorio por defecto de apache2. (/var/www/html)
- Exponemos el puerto 80 (por defecto de apache)
- Ejectuamos apache en primer plano. (Si no, el contenedor se parar铆a inmediatamente)


**Construcci贸n de la imagen**

Construimos la imagen, con el nombre `iessdf/imagen-web-php:v1`

```bash
docker build -t iessdf/imagen-web-php:v1 .
```

Compobar que la imagen se ha creado:

```bash
docker images

REPOSITORY                 TAG                 IMAGE ID            CREATED             SIZE
iessdf/imagen-web-php      v1                  5f6b6b6b6b6b        2 minutes ago       126MB
```


Y crear el contenedor a partir de la imagen, con el nombre `web-php`:

>  Puerto ya utilizado.<br>
> Recordar que el otro caso pr谩ctico, el contenedor est谩 escuchando en el puerto 80. Por lo tanto, tenemos que parar el contenedor anterior para poder ejecutar este.


```bash
docker run -d --name web-php -p 80:80 iessdf/imagen-web-php:v1
```


Y acceder con el navegador a la direcci贸n http://localhost

<img src="res/img/04.caso-practico2-1.png">


La aplicaci贸n tiene un fichero info.php que me da informaci贸n sobre PHP, en este caso observamos que estamos usando la versi贸n 7.3:

<img src="res/img/04.caso-practico2-2.png">





## 讹 Caso pr谩ctico 3. Construcci贸n desde uma imagen con PHP Instalado (Version 2)

> 锔 *(En este caso pr谩ctico vamos a usar el mismo c贸digo fuente que en el caso pr谩ctico 2), si ya est谩n descargados no hace falta volver a descargarlos.*

En esta version en lugar de tener que instalar apache2 y php, vamos a usar una imagen base que ya tenga instalado apache2 y php.<br>
Normalmente, es recomendable usar una imagen base que ya tenga instalado los paquetes que necesitamos, ya que nos ahorramos tiempo, espacio en disco y estar谩 m谩s optimizada.

>  Nota: Antes de configurar desde una imagen base, es mucho mejor investigar si existe una imagen que ya tenga lo que nosotros necesitamos.<br>
> Despu茅s simplemente tenemos que configurarla para que se ajuste a nuestras necesidades.


En el DockerFile, simplemente tenemos que cambiar la imagen base:

```dockerfile
FROM php:7.4-apache
ADD app /var/www/html/
EXPOSE 80
# No es necesario indicar el comando por defecto, ya que la imagen base ya lo tiene configurado.
```

Y al igual que en la versi贸n 1, construimos la imagen, esta vez con la versi贸n (v2) `iessdf/imagen-web-php:v2`

```bash
docker build -t iessdf/imagen-web-php:v2 .
```

Y crear el contenedor a partir de la imagen, con el nombre `web-php`:


```bash
docker run -d --name web-php2 -p 80:80 iessdf/imagen-web-php:v2
```

Y acceder con el navegador a la direcci贸n http://localhost

<img src="res/img/04.caso-practico3-1.png">
